name: Estudify CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.12'

jobs:
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dev tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pre-commit black isort flake8
          pip install -r requirements.txt

      - name: Run pre-commit (formatting + checks)
        run: |
          pre-commit run --all-files || true

      - name: Lint with flake8
        run: |
          # Run flake8 using project config; fail the job if any style issues are found
          flake8 . --count --show-source --statistics --max-complexity=10 --max-line-length=127

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    env:
      # For the unit/test job run Celery tasks eagerly (no external worker required)
      CELERY_TASK_ALWAYS_EAGER: 'true'
      CELERY_TASK_EAGER_PROPAGATES: 'true'
      # Backwards-compat: signal to tests if they want to start an in-test worker
      TEST_USE_STARTER_WORKER: 'true'
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Create .env for CI
        run: |
          echo "SECRET_KEY=test-secret-key-for-ci" > .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env
          echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
          echo "CELERY_BROKER_URL=redis://localhost:6379/0" >> .env
          echo "CELERY_TASK_ALWAYS_EAGER=True" >> .env
          echo "CELERY_TASK_EAGER_PROPAGATES=True" >> .env
          echo "EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend" >> .env

      - name: Run migrations
        run: python manage.py migrate --noinput


      - name: Collect pytest (diagnostic)
        run: |
          mkdir -p pytest-results
          python -m pytest --collect-only -q 2>&1 | tee pytest-results/collect.txt || true
        continue-on-error: true

      - name: Run tests (pytest) with coverage and junit
        run: |
          mkdir -p pytest-results
          # Run unit/tests excluding integration tests directory
          pytest --maxfail=1 -q --junitxml=pytest-results/junit.xml --cov=apps --cov-report=xml:coverage.xml --cov-report=html --ignore=tests/integration

      - name: Upload pytest collect artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-collect
          path: pytest-results/collect.txt

      - name: Upload pytest junit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-junit
          path: pytest-results/junit.xml

      - name: Upload coverage html
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov

      - name: Upload coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Upload test results to Codecov (test-results)
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit
          pip install -r requirements.txt

      - name: pip-audit (write json)
        run: |
          pip-audit --format=json -o audit.json || true

      - name: safety check (dependencies)
        run: |
          safety check --json > safety.json || true

      - name: bandit scan
        run: |
          bandit -r apps/ -f json -o bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            audit.json
            safety.json
            bandit-report.json

  integration:
    name: Integration tests (Redis + Celery)
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: lint
    env:
      CELERY_BROKER_URL: 'redis://localhost:6379/0'
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Create .env for CI
        run: |
          echo "SECRET_KEY=test-secret-key-for-ci" > .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env
          echo "DATABASE_URL=sqlite:///db.sqlite3" >> .env
          echo "CELERY_BROKER_URL=redis://localhost:6379/0" >> .env
          echo "EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend" >> .env

      - name: Wait for Redis to be ready
        run: |
          python - <<'PY'
          import socket, time, sys, subprocess

          def try_redis_cli():
              try:
                  out = subprocess.check_output(['redis-cli', 'ping'], stderr=subprocess.STDOUT, timeout=2)
                  return out.strip() == b'PONG'
              except Exception:
                  return False

          for i in range(60):
              # Prefer redis-cli ping when available
              if try_redis_cli():
                  print('Redis reachable (redis-cli)')
                  sys.exit(0)
              try:
                  s = socket.socket()
                  s.settimeout(1)
                  s.connect(('localhost', 6379))
                  s.close()
                  print('Redis reachable (socket)')
                  sys.exit(0)
              except Exception:
                  print('Waiting for Redis...')
                  time.sleep(1)
          print('Redis not reachable after timeout')
          sys.exit(1)
          PY

      - name: Run migrations
        run: python manage.py migrate --noinput

      - name: Start Celery worker (background) and capture logs
        run: |
          mkdir -p pytest-results
          # Start worker and redirect logs to a file for later upload
          # Use --pool=solo to avoid multiprocessing issues on some runners
          nohup python -m celery -A config worker -l info --pool=solo > pytest-results/worker.log 2>&1 &
          sleep 4

      - name: Run integration tests
        run: |
          pytest tests/integration/ -q --maxfail=1 --junitxml=pytest-results/integration-junit.xml

      - name: Upload integration junit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-junit
          path: pytest-results/integration-junit.xml

      - name: Upload worker logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: celery-worker-log
          path: pytest-results/worker.log

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}'

      - name: Notify deployment
        run: |
          echo "Deployment triggered successfully!"

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.security.result }}" == "success" ]; then
            echo "All checks passed!"
            exit 0
          else
            echo "Some checks failed"
            exit 1
          fi
